---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import ReviewCard from "@/components/ReviewCard.astro";
import RatingBadge from "@/components/RatingBadge.astro";
import GenreTag from "@/components/GenreTag.astro";
import LinkButton from "@/components/LinkButton.astro";
import getSortedReviews from "@/utils/getSortedReviews";
import getUniqueGenres from "@/utils/getUniqueGenres";
import { slugifyStr } from "@/utils/slugify";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";

const allReviews = await getCollection("reviews");
const sortedReviews = getSortedReviews(allReviews);

// Featured review (first featured, or fall back to highest-rated)
const featuredReview =
  sortedReviews.find(r => r.data.featured) ??
  [...sortedReviews].sort((a, b) => b.data.rating - a.data.rating)[0];

// Recent reviews (exclude featured, show up to postPerIndex)
const recentReviews = sortedReviews
  .filter(r => r.id !== featuredReview?.id)
  .slice(0, SITE.postPerIndex);

// Top-rated (8+, excluding featured, up to 6)
const topRatedReviews = [...sortedReviews]
  .filter(r => r.data.rating >= 8 && r.id !== featuredReview?.id)
  .sort((a, b) => b.data.rating - a.data.rating)
  .slice(0, 6);

// Genre quick-links
const genres = getUniqueGenres(allReviews).slice(0, 8);
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index">

    <!-- ─── Featured review hero ─── -->
    {
      featuredReview && (
        <section class="border-b border-border bg-muted/20">
          <div class="app-layout py-10 sm:py-16">
            <p class="mb-4 font-mono text-xs uppercase tracking-widest text-foreground/40">
              Featured Review
            </p>
            <a
              href={`/reviews/${featuredReview.id}/`}
              class="group flex flex-col gap-6 sm:flex-row sm:items-start sm:gap-10 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent"
            >
              {featuredReview.data.coverImage && (
                <div class="relative flex-none self-start">
                  <img
                    src={featuredReview.data.coverImage}
                    alt={`${featuredReview.data.artist} — ${featuredReview.data.title}`}
                    class="h-48 w-48 object-cover shadow-xl sm:h-64 sm:w-64"
                    loading="eager"
                  />
                </div>
              )}
              <div class="flex flex-col gap-4">
                <div>
                  <p class="font-display text-xs font-semibold uppercase tracking-widest text-accent">
                    {featuredReview.data.artist}
                  </p>
                  <h2 class="mt-1 font-display text-3xl font-bold uppercase leading-tight tracking-wide group-hover:text-accent transition-colors sm:text-4xl">
                    {featuredReview.data.title}
                  </h2>
                  <p class="mt-1 font-mono text-sm text-foreground/50">
                    {featuredReview.data.releaseYear}
                  </p>
                </div>
                <div class="flex flex-wrap gap-2">
                  {featuredReview.data.genre.map(g => (
                    <GenreTag genre={slugifyStr(g)} genreName={g} />
                  ))}
                </div>
                <p class="font-body text-base text-foreground/75 line-clamp-3 max-w-xl">
                  {featuredReview.data.description}
                </p>
                <div>
                  <RatingBadge rating={featuredReview.data.rating} size="lg" />
                </div>
              </div>
            </a>
          </div>
        </section>
      )
    }

    <!-- ─── Genre quick-links ─── -->
    {
      genres.length > 0 && (
        <section class="border-b border-border">
          <div class="app-layout py-5">
            <div class="flex flex-wrap items-center gap-2">
              <span class="font-mono text-xs uppercase tracking-widest text-foreground/40 me-1">
                Genres:
              </span>
              {genres.map(({ genre, genreName }) => (
                <GenreTag genre={genre} genreName={genreName} href={`/genres/${genre}/`} />
              ))}
              <a
                href="/genres/"
                class="font-mono text-xs uppercase tracking-widest text-foreground/40 hover:text-accent transition-colors ms-1"
              >
                All →
              </a>
            </div>
          </div>
        </section>
      )
    }

    <!-- ─── Latest reviews grid ─── -->
    {
      recentReviews.length > 0 && (
        <section class="border-b border-border">
          <div class="app-layout py-10">
            <h2 class="mb-6 font-display text-sm font-semibold uppercase tracking-widest text-foreground/50">
              Latest Reviews
            </h2>
            <ul class="grid grid-cols-2 gap-4 sm:grid-cols-3">
              {recentReviews.map(review => (
                <ReviewCard {...review} />
              ))}
            </ul>
            <div class="mt-8">
              <LinkButton href="/reviews/">
                All Reviews
                <IconArrowRight class="inline-block rtl:-rotate-180" />
              </LinkButton>
            </div>
          </div>
        </section>
      )
    }

    <!-- ─── Top Rated ─── -->
    {
      topRatedReviews.length > 0 && (
        <section>
          <div class="app-layout py-10">
            <h2 class="mb-6 font-display text-sm font-semibold uppercase tracking-widest text-foreground/50">
              Top Rated
            </h2>
            <ul class="grid grid-cols-2 gap-4 sm:grid-cols-3">
              {topRatedReviews.map(review => (
                <ReviewCard {...review} />
              ))}
            </ul>
          </div>
        </section>
      )
    }

  </main>
  <Footer />
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document.querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;
    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
