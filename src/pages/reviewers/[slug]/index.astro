---
import { type CollectionEntry, getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import ReviewCard from "@/components/ReviewCard.astro";
import getSortedReviews from "@/utils/getSortedReviews";
import { SITE } from "@/config";

export async function getStaticPaths() {
  const reviewers = await getCollection("reviewers");
  return reviewers.map(reviewer => ({
    params: { slug: reviewer.data.slug },
    props: { reviewer },
  }));
}

type Props = { reviewer: CollectionEntry<"reviewers"> };
const { reviewer } = Astro.props;

const allReviews = await getCollection("reviews");
const reviewerReviews = getSortedReviews(allReviews).filter(
  r => r.data.reviewer === reviewer.data.slug
);
---

<Layout
  title={`${reviewer.data.name} | ${SITE.title}`}
  description={reviewer.data.bio}
>
  <Header />
  <main id="main-content" class="app-layout pb-12">
    <nav class="pt-4 pb-2 font-mono text-xs uppercase tracking-widest text-foreground/50">
      <a href="/reviewers/" class="hover:text-accent">Reviewers</a>
      <span class="mx-2">/</span>
      <span>{reviewer.data.name}</span>
    </nav>

    <!-- Reviewer profile -->
    <div class="mt-4 mb-10 flex flex-col gap-6 border-b border-border pb-10 sm:flex-row sm:items-start">
      {
        reviewer.data.avatar ? (
          <img
            src={reviewer.data.avatar}
            alt={reviewer.data.name}
            class="h-24 w-24 flex-none object-cover sm:h-32 sm:w-32"
          />
        ) : (
          <div class="flex h-24 w-24 flex-none items-center justify-center bg-muted sm:h-32 sm:w-32">
            <span class="font-display text-4xl font-bold text-accent">
              {reviewer.data.name.charAt(0)}
            </span>
          </div>
        )
      }
      <div class="flex flex-col gap-3">
        <h1 class="font-display text-3xl font-bold uppercase tracking-wide">
          {reviewer.data.name}
        </h1>
        {
          reviewer.data.bio && (
            <p class="font-body text-base text-foreground/80">{reviewer.data.bio}</p>
          )
        }
        {
          reviewer.data.links && reviewer.data.links.length > 0 && (
            <div class="flex flex-wrap gap-3">
              {reviewer.data.links.map(link => (
                <a
                  href={link.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="border border-border px-3 py-1 font-mono text-xs uppercase tracking-widest text-foreground/60 transition-colors hover:border-accent hover:text-accent"
                >
                  {link.label}
                </a>
              ))}
            </div>
          )
        }
        <p class="font-mono text-xs uppercase tracking-widest text-foreground/40">
          {reviewerReviews.length} {reviewerReviews.length === 1 ? "review" : "reviews"}
        </p>
      </div>
    </div>

    <!-- Their reviews -->
    {
      reviewerReviews.length > 0 ? (
        <ul class="grid grid-cols-2 gap-4 sm:grid-cols-3">
          {reviewerReviews.map(review => (
            <ReviewCard {...review} />
          ))}
        </ul>
      ) : (
        <p class="font-body text-foreground/60">No reviews published yet.</p>
      )
    }
  </main>
  <Footer />
</Layout>
