---
import type { GetStaticPaths, Page } from "astro";
import { type CollectionEntry, getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import ReviewCard from "@/components/ReviewCard.astro";
import Pagination from "@/components/Pagination.astro";
import reviewFilter from "@/utils/reviewFilter";
import getReviewsByDecade from "@/utils/getReviewsByDecade";
import { SITE } from "@/config";

type Props = {
  page: Page<CollectionEntry<"reviews">>;
  decade: number;
};

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const allReviews = await getCollection("reviews");
  const filteredReviews = allReviews.filter(reviewFilter);

  const decades = [
    ...new Set(
      filteredReviews.map(r => Math.floor(r.data.releaseYear / 10) * 10)
    ),
  ];

  return decades.flatMap(decade => {
    const decadeReviews = getReviewsByDecade(allReviews, decade);
    return paginate(decadeReviews, {
      params: { decade: String(decade) },
      props: { decade },
      pageSize: SITE.postPerPage,
    });
  });
};

const { page, decade } = Astro.props;
const decadeLabel = `${decade}s`;
---

<Layout title={`${decadeLabel} | ${SITE.title}`}>
  <Header />
  <main id="main-content" class="app-layout pb-12">
    <nav class="pt-4 pb-2 font-mono text-xs uppercase tracking-widest text-foreground/50">
      <a href="/decades/" class="hover:text-accent">Decades</a>
      <span class="mx-2">/</span>
      <span>{decadeLabel}</span>
    </nav>
    <h1 class="mt-2 mb-6 font-display text-3xl font-bold uppercase tracking-wide">
      The {decadeLabel}
    </h1>

    {
      page.data.length > 0 ? (
        <>
          <ul class="grid grid-cols-2 gap-4 sm:grid-cols-3">
            {page.data.map(review => (
              <ReviewCard {...review} />
            ))}
          </ul>
          <Pagination {page} />
        </>
      ) : (
        <p class="font-body text-foreground/60">No reviews from this decade.</p>
      )
    }
  </main>
  <Footer />
</Layout>
