---
import { type CollectionEntry, getCollection, render } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Tag from "@/components/Tag.astro";
import Datetime from "@/components/Datetime.astro";
import BackButton from "@/components/BackButton.astro";
import BackToTopButton from "@/components/BackToTopButton.astro";
import { slugifyStr } from "@/utils/slugify";
import getSortedReviews from "@/utils/getSortedReviews";
import { SITE } from "@/config";
import IconChevronLeft from "@/assets/icons/IconChevronLeft.svg";
import IconChevronRight from "@/assets/icons/IconChevronRight.svg";

export async function getStaticPaths() {
  const reviews = await getCollection("reviews", ({ data }) => !data.draft);
  return reviews.map(review => ({
    params: { slug: review.id },
    props: { review },
  }));
}

type Props = { review: CollectionEntry<"reviews"> };
const { review } = Astro.props;

const {
  title,
  artist,
  rating,
  releaseYear,
  genre,
  coverImage,
  description,
  pubDatetime,
  modDatetime,
  tags,
} = review.data;

const { Content } = await render(review);

const allReviews = await getCollection("reviews");
const sortedReviews = getSortedReviews(allReviews);
const currentIndex = sortedReviews.findIndex(r => r.id === review.id);
const prevReview = currentIndex !== 0 ? sortedReviews[currentIndex - 1] : null;
const nextReview =
  currentIndex !== sortedReviews.length - 1
    ? sortedReviews[currentIndex + 1]
    : null;

const layoutProps = {
  title: `${artist} — ${title} | ${SITE.title}`,
  description,
  pubDatetime,
  modDatetime,
  scrollSmooth: true,
};
---

<Layout {...layoutProps}>
  <Header />
  <BackButton />
  <main
    id="main-content"
    class:list={["app-layout pb-12", { "mt-8": !SITE.showBackButton }]}
    data-pagefind-body
  >
    <h1
      transition:name={slugifyStr(title.replaceAll(".", "-"))}
      class="inline-block text-2xl font-bold text-accent sm:text-3xl"
    >
      {artist} — {title}
    </h1>

    <div class="my-3 flex flex-wrap items-center gap-x-4 gap-y-1 text-sm">
      <span class="text-2xl font-bold text-accent">{rating}/10</span>
      <span class="opacity-70">{releaseYear}</span>
      <span class="opacity-70">{genre.join(", ")}</span>
    </div>

    <Datetime {pubDatetime} {modDatetime} size="lg" />

    {
      coverImage && (
        <img
          src={coverImage}
          alt={`${artist} — ${title} cover`}
          class="my-6 h-48 w-48 rounded object-cover shadow-md"
          loading="lazy"
        />
      )
    }

    <article
      id="article"
      class="app-prose mt-8 w-full max-w-app prose-pre:bg-(--shiki-light-bg) dark:prose-pre:bg-(--shiki-dark-bg)"
    >
      <Content />
    </article>

    <hr class="my-8 border-dashed" />

    {
      tags.length > 0 && (
        <ul class="mt-4 mb-8 flex flex-wrap gap-4 sm:my-8">
          {tags.map(tag => (
            <Tag tag={slugifyStr(tag)} tagName={tag} size="sm" />
          ))}
        </ul>
      )
    }

    <BackToTopButton />

    <hr class="my-6 border-dashed" />

    <div data-pagefind-ignore class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      {
        prevReview && (
          <a
            href={`/reviews/${prevReview.id}/`}
            class="flex w-full gap-1 hover:opacity-75"
          >
            <IconChevronLeft class="inline-block flex-none rtl:rotate-180" />
            <div>
              <span>Previous Review</span>
              <div class="text-sm text-accent/85">
                {prevReview.data.artist} — {prevReview.data.title}
              </div>
            </div>
          </a>
        )
      }
      {
        nextReview && (
          <a
            href={`/reviews/${nextReview.id}/`}
            class="flex w-full justify-end gap-1 text-end hover:opacity-75 sm:col-start-2"
          >
            <div>
              <span>Next Review</span>
              <div class="text-sm text-accent/85">
                {nextReview.data.artist} — {nextReview.data.title}
              </div>
            </div>
            <IconChevronRight class="inline-block flex-none rtl:rotate-180" />
          </a>
        )
      }
    </div>
  </main>
  <Footer />
</Layout>

<script is:inline data-astro-rerun>
  function createProgressBar() {
    const progressContainer = document.createElement("div");
    progressContainer.className =
      "progress-container fixed top-0 z-10 h-1 w-full bg-background";
    const progressBar = document.createElement("div");
    progressBar.className = "progress-bar h-1 w-0 bg-accent";
    progressBar.id = "myBar";
    progressContainer.appendChild(progressBar);
    document.body.appendChild(progressContainer);
  }
  createProgressBar();

  function updateScrollProgress() {
    document.addEventListener("scroll", () => {
      const winScroll =
        document.body.scrollTop || document.documentElement.scrollTop;
      const height =
        document.documentElement.scrollHeight -
        document.documentElement.clientHeight;
      const scrolled = (winScroll / height) * 100;
      const myBar = document.getElementById("myBar");
      if (myBar) myBar.style.width = scrolled + "%";
    });
  }
  updateScrollProgress();

  document.addEventListener("astro:after-swap", () =>
    window.scrollTo({ left: 0, top: 0, behavior: "instant" })
  );
</script>
