---
import { type CollectionEntry, getCollection, render } from "astro:content";
import ReviewLayout from "@/layouts/ReviewLayout.astro";
import getSortedReviews from "@/utils/getSortedReviews";
import getReviewsByGenre from "@/utils/getReviewsByGenre";
import { slugifyStr } from "@/utils/slugify";

export async function getStaticPaths() {
  const reviews = await getCollection("reviews", ({ data }) => !data.draft);
  return reviews.map(review => ({
    params: { slug: review.id },
    props: { review },
  }));
}

type Props = { review: CollectionEntry<"reviews"> };
const { review } = Astro.props;

const { Content } = await render(review);

const allReviews = await getCollection("reviews");
const sortedReviews = getSortedReviews(allReviews);
const currentIndex = sortedReviews.findIndex(r => r.id === review.id);
const prevReview = currentIndex !== 0 ? sortedReviews[currentIndex - 1] : null;
const nextReview =
  currentIndex !== sortedReviews.length - 1
    ? sortedReviews[currentIndex + 1]
    : null;

// Related: same primary genre, excluding current review
const primaryGenre = slugifyStr(review.data.genre[0] ?? "");
const relatedReviews = primaryGenre
  ? getReviewsByGenre(allReviews, primaryGenre).filter(r => r.id !== review.id)
  : [];
---

<ReviewLayout
  {review}
  {prevReview}
  {nextReview}
  relatedReviews={relatedReviews}
>
  <Content />
</ReviewLayout>
